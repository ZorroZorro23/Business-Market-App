<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>AtlasGo Market Scanner</title>
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a1a;
      color: #eee;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    #sidebar {
      width: 350px;
      background: #222;
      border-right: 1px solid #444;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10;
      box-shadow: 2px 0 10px #000;
    }

    h2 { color: #3b82f6; margin: 0 0 10px 0; font-size: 22px; }
    label { font-size: 11px; color: #aaa; font-weight: bold; display: block; margin-bottom: 3px; }

    input, select, button {
      width: 100%;
      padding: 8px;
      background: #333;
      border: 1px solid #555;
      color: white;
      border-radius: 4px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }

    button {
      font-weight: bold;
      cursor: pointer;
      text-transform: uppercase;
      border: none;
      transition: 0.2s;
    }

    .btn-scan { background: #3b82f6; margin-top: 5px; }
    .btn-scan:hover { background: #2563eb; }

    .btn-geo {
      background: transparent;
      border: 1px solid #27ae60;
      color: #27ae60;
      margin-bottom: 15px;
    }
    .btn-geo:hover { background: rgba(39, 174, 96, 0.1); }

    #results {
      flex: 1;
      overflow-y: auto;
      border-top: 1px solid #444;
      padding-top: 10px;
      min-height: 0;
    }

    .card {
      padding: 12px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      position: relative;
      transition: 0.2s;
      display: flex;
      gap: 10px;
    }
    .card:hover { background: #2a2a2a; border-left: 3px solid #3b82f6; }

    .place-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #444; }
    .place-info { flex: 1; padding-right: 36px; }

    .route-info { font-size: 11px; color: #27ae60; margin-top: 5px; font-weight: bold; display: none; }
    .transit-steps {
      font-size: 10px; color: #ddd; margin-top: 4px;
      background: rgba(255,255,255,0.1); padding: 4px; border-radius: 4px;
    }
    .step-badge {
      display: inline-block;
      background: #333;
      border: 1px solid #555;
      padding: 1px 4px;
      border-radius: 3px;
      margin-right: 3px;
      margin-bottom: 2px;
    }

    .best-badge { position: absolute; top: 8px; right: 8px; background: #27ae60; font-size: 9px; padding: 2px 5px; border-radius: 3px; }

    .fav-btn {
      position: absolute;
      right: 10px;
      top: 38px;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: #2b2b2b;
      border: 1px solid #555;
      color: #f1c40f;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
    }
    .fav-btn:hover { background: #333; }

    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .auth-btn {
      width:auto;
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 6px;
      background: transparent;
      border: 1px solid #3b82f6;
      color: #3b82f6;
      margin-bottom: 0;
      text-transform: none;
      white-space: nowrap;
    }
    .auth-btn:hover { background: rgba(59,130,246,0.12); }

    .mini-block {
      background: rgba(255,255,255,0.04);
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
    }
    .mini-title {
      font-size: 11px;
      color: #aaa;
      font-weight: 700;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .mini-item {
      font-size: 11px;
      color: #ddd;
      padding: 6px;
      border-radius: 6px;
      cursor: pointer;
      background: rgba(255,255,255,0.03);
      margin-bottom: 6px;
    }
    .mini-item:hover { background: rgba(59,130,246,0.12); }
    .mini-muted { color: #888; font-size: 10px; }

    #mapWrap {
      position: relative;
      flex: 1;
      min-width: 0;
      height: 100vh;
      background: #111;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #111;
    }

    #sv-panel {
      position: absolute;
      bottom: 30px;
      right: 20px;
      width: 350px;
      height: 250px;
      background: #000;
      border: 3px solid #fff;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.7);
      display: none;
      z-index: 99;
      overflow: hidden;
    }
    #sv-container { width: 100%; height: 100%; }
    #sv-close {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #e74c3c;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      z-index: 100;
    }
    #sv-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 10px;
      padding: 5px;
      text-align: center;
      pointer-events: none;
      z-index: 99;
    }

    @media (max-width: 768px) {
      body { flex-direction: column; }

      #sidebar {
        width: 100%;
        height: 60vh;
        order: 2;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        padding: 10px;
        z-index: 20;
        gap: 5px;
      }

      #mapWrap {
        width: 100%;
        height: 40vh;
        order: 1;
      }

      h2 { display: none; }
      label { display: none; }
      input, select, button { padding: 8px; margin-bottom: 5px; font-size: 13px; }
      .btn-geo { margin-bottom: 5px; padding: 5px; }

      #results {
        height: 100%;
        overflow-y: auto;
        background: #222;
        border: 1px solid #333;
      }

      .topbar { margin-bottom: 0; }
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <div class="topbar">
      <h2 style="margin:0;">AtlasGo <span style="font-size:12px; color:#888">v4.0 Student</span></h2>
      <button id="authBtn" class="auth-btn" type="button">Login</button>
    </div>

    <button class="btn-geo" onclick="locateUser()">üìç LocalizeazƒÉ-mƒÉ (GPS)</button>

    <label>CAUTA ORAS</label>
    <input id="city" type="text" placeholder="Ex: Voluntari...">

    <label>CATEGORIE</label>
    <select id="cat">
      <option value="convenience_store">Magazine / Minimarket</option>
      <option value="gas_station">Benzinarii</option>
      <option value="restaurant|cafe">Restaurante</option>
      <option value="tourist_attraction">Turism</option>
      <option value="spa|park">Relaxare</option>
      <option value="pharmacy">Farmacii</option>
      <option value="gym">Sala Fitness</option>
    </select>

    <div style="display:flex; gap:10px;">
      <div style="flex:1">
        <label>MOD TRANSPORT</label>
        <select id="travelMode" onchange="updateRouteMode()">
          <option value="DRIVING">üöó Ma»ôinƒÉ</option>
          <option value="TRANSIT" selected>üöå Autobuz/Metrou</option>
          <option value="WALKING">üö∂ Jos</option>
          <option value="BICYCLING">üö¥ BicicletƒÉ</option>
        </select>
      </div>
      <div style="flex:1">
        <label>RAZA: <span id="rVal">1500</span>m</label>
        <input id="rad" type="range" min="500" max="10000" value="1500" step="100" oninput="document.getElementById('rVal').innerText=this.value">
      </div>
    </div>

    <label>SORTARE</label>
    <select id="sort">
      <option value="dist">Distanta (Cel mai aproape)</option>
      <option value="rate">Rating (Cel mai bun)</option>
      <option value="best">Balansat (Best Match)</option>
    </select>

    <button class="btn-scan" onclick="runScan()">Scaneaza Zona</button>

    <div style="font-size:11px; color:#666; margin-top:5px">
      Rezultate: <span id="count">0</span>
    </div>

    <div id="historyBox" class="mini-block" style="display:none;">
      <div class="mini-title">
        <span>Istoric cƒÉutƒÉri</span>
        <span class="mini-muted" id="historyMeta"></span>
      </div>
      <div id="historyList"></div>
    </div>

    <div id="results"></div>
  </div>

  <div id="mapWrap">
    <div id="map"></div>
    <div id="sv-panel">
      <button id="sv-close" onclick="document.getElementById('sv-panel').style.display='none'">X</button>
      <div id="sv-container"></div>
      <div id="sv-label">Street View Interactiv</div>
    </div>
  </div>

  <script type="module" src="./assets/firebase.js"></script>

  <script>
    let map, circle, service, directionsService, directionsRenderer
    let miniStreetView
    let markers = []
    let userPos = { lat: 44.4268, lng: 26.1025 }

    let currentSelectedDest = null
    let currentSelectedMsgId = null

    const LS_STATE = "atlasgo_last_state_v1"
    const LS_HISTORY = "atlasgo_history_v1"
    const LS_FAVS = "atlasgo_favs_v1"

    function safeParseJSON(s, fallback) {
      try { return JSON.parse(s) } catch { return fallback }
    }

    function byId(id) {
      return document.getElementById(id)
    }

    function getAuthUser() {
      return window.__authUser || null
    }

    function updateAuthButton() {
      const btn = byId("authBtn")
      if (!btn) return
      const u = getAuthUser()
      if (u) {
        btn.textContent = "Logout"
        btn.onclick = () => {
          if (window.logout) window.logout()
          else location.href = "./login.html"
        }
      } else {
        btn.textContent = "Login"
        btn.onclick = () => { location.href = "./login.html" }
      }
    }

    window.addEventListener("auth-changed", updateAuthButton)

    function requireLoginOrWarn() {
      const u = getAuthUser()
      if (!u) {
        alert("Trebuie sƒÉ fii autentificat ca sƒÉ salvezi favoritele »ôi istoricul.")
        return null
      }
      return u
    }

    function loadState() {
      const raw = localStorage.getItem(LS_STATE)
      const st = safeParseJSON(raw, null)
      if (!st) return
      const city = byId("city")
      const cat = byId("cat")
      const mode = byId("travelMode")
      const sort = byId("sort")
      const rad = byId("rad")
      const rVal = byId("rVal")

      if (city && typeof st.city === "string") city.value = st.city
      if (cat && typeof st.cat === "string") cat.value = st.cat
      if (mode && typeof st.travelMode === "string") mode.value = st.travelMode
      if (sort && typeof st.sort === "string") sort.value = st.sort
      if (rad && typeof st.rad === "number") rad.value = String(st.rad)
      if (rVal && typeof st.rad === "number") rVal.innerText = String(st.rad)
    }

    function saveState() {
      const city = byId("city")
      const cat = byId("cat")
      const mode = byId("travelMode")
      const sort = byId("sort")
      const rad = byId("rad")

      const st = {
        city: city ? (city.value || "") : "",
        cat: cat ? cat.value : "convenience_store",
        travelMode: mode ? mode.value : "TRANSIT",
        sort: sort ? sort.value : "dist",
        rad: rad ? parseInt(rad.value, 10) : 1500
      }
      localStorage.setItem(LS_STATE, JSON.stringify(st))
    }

    function readHistory() {
      const h = safeParseJSON(localStorage.getItem(LS_HISTORY), [])
      return Array.isArray(h) ? h : []
    }

    function writeHistory(arr) {
      const safeArr = Array.isArray(arr) ? arr : []
      localStorage.setItem(LS_HISTORY, JSON.stringify(safeArr))
    }

    function addHistoryEntry(entry) {
      const u = requireLoginOrWarn()
      if (!u) return
      const arr = readHistory()
      arr.unshift(entry)
      writeHistory(arr.slice(0, 10))
      renderHistory()
    }

    function renderHistory() {
      const box = byId("historyBox")
      const list = byId("historyList")
      const meta = byId("historyMeta")
      if (!box || !list || !meta) return

      const arr = readHistory()
      if (!arr.length) {
        box.style.display = "none"
        return
      }

      box.style.display = "block"
      meta.textContent = String(arr.length) + " salvate"
      list.innerHTML = ""

      arr.forEach((h) => {
        const div = document.createElement("div")
        div.className = "mini-item"
        const line1 = (h.city && String(h.city).trim()) ? h.city : "Zona curentƒÉ"
        const line2 = `${h.catLabel} ‚Ä¢ ${h.rad}m ‚Ä¢ ${h.modeLabel} ‚Ä¢ ${h.sortLabel}`
        div.innerHTML = `<div style="font-weight:700">${line1}</div><div class="mini-muted">${line2}</div>`
        div.onclick = () => {
          const city = byId("city")
          const cat = byId("cat")
          const mode = byId("travelMode")
          const sort = byId("sort")
          const rad = byId("rad")
          const rVal = byId("rVal")

          if (city) city.value = h.city || ""
          if (cat) cat.value = h.cat
          if (mode) mode.value = h.mode
          if (sort) sort.value = h.sort
          if (rad) rad.value = String(h.rad)
          if (rVal) rVal.innerText = String(h.rad)
          saveState()
          runScan()
        }
        list.appendChild(div)
      })
    }

    function readFavs() {
      const f = safeParseJSON(localStorage.getItem(LS_FAVS), {})
      return f && typeof f === "object" ? f : {}
    }

    function writeFavs(obj) {
      const safeObj = obj && typeof obj === "object" ? obj : {}
      localStorage.setItem(LS_FAVS, JSON.stringify(safeObj))
    }

    function isFav(placeId) {
      const favs = readFavs()
      return Boolean(favs[placeId])
    }

    function toggleFav(placeObj) {
      const u = requireLoginOrWarn()
      if (!u) return
      const placeId = placeObj.place_id
      if (!placeId) return

      const favs = readFavs()
      if (favs[placeId]) {
        delete favs[placeId]
      } else {
        favs[placeId] = {
          place_id: placeId,
          name: placeObj.name || "",
          vicinity: placeObj.vicinity || "",
          lat: placeObj.geometry && placeObj.geometry.location ? placeObj.geometry.location.lat() : null,
          lng: placeObj.geometry && placeObj.geometry.location ? placeObj.geometry.location.lng() : null,
          rating: placeObj.rating || 0,
          ts: Date.now()
        }
      }
      writeFavs(favs)

      const btn = document.querySelector(`[data-fav-id="${placeId}"]`)
      if (btn) btn.textContent = favs[placeId] ? "‚òÖ" : "‚òÜ"
    }

    function getCategoryKeywords(raw) {
      return String(raw).split("|").map(s => s.trim()).filter(Boolean)
    }

    function labelForCategoryValue(v) {
      const sel = byId("cat")
      if (!sel) return v
      const opt = sel.querySelector(`option[value="${v}"]`)
      return opt ? (opt.textContent || v) : v
    }

    function labelForSort(v) {
      if (v === "dist") return "Distan»õƒÉ"
      if (v === "rate") return "Rating"
      return "Best"
    }

    function labelForMode(v) {
      if (v === "DRIVING") return "Ma»ôinƒÉ"
      if (v === "TRANSIT") return "Transit"
      if (v === "WALKING") return "Jos"
      if (v === "BICYCLING") return "BicicletƒÉ"
      return v
    }

    function initMap() {
      try {
        loadState()
        renderHistory()
        updateAuthButton()
      } catch (e) {
        updateAuthButton()
      }

      map = new google.maps.Map(byId("map"), {
        center: userPos,
        zoom: 13,
        disableDefaultUI: false,
        streetViewControl: true,
        mapTypeControl: false
      })

      new google.maps.TransitLayer().setMap(map)

      directionsService = new google.maps.DirectionsService()
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: "#3b82f6", strokeWeight: 6, strokeOpacity: 0.7 }
      })

      miniStreetView = new google.maps.StreetViewPanorama(
        byId("sv-container"),
        {
          position: userPos,
          pov: { heading: 34, pitch: 10 },
          visible: true,
          disableDefaultUI: false,
          zoomControl: true,
          panControl: true
        }
      )

      const rad = byId("rad")
      const radius = rad ? parseInt(rad.value, 10) : 1500

      circle = new google.maps.Circle({
        map: map,
        center: userPos,
        radius: radius || 1500,
        fillColor: "#3b82f6",
        fillOpacity: 0.1,
        strokeColor: "#3b82f6",
        strokeWeight: 2,
        editable: true,
        draggable: true
      })

      circle.addListener("center_changed", () => { userPos = circle.getCenter() })

      service = new google.maps.places.PlacesService(map)

      const cityInput = byId("city")
      if (cityInput) {
        const ac = new google.maps.places.Autocomplete(cityInput)
        ac.bindTo("bounds", map)
        ac.addListener("place_changed", () => {
          const p = ac.getPlace()
          if (p.geometry) {
            userPos = p.geometry.location
            updateMapCenter()
          }
        })
        cityInput.addEventListener("input", saveState)
      }

      const cat = byId("cat")
      const mode = byId("travelMode")
      const sort = byId("sort")
      if (cat) cat.addEventListener("change", saveState)
      if (mode) mode.addEventListener("change", saveState)
      if (sort) sort.addEventListener("change", saveState)
      if (rad) rad.addEventListener("input", saveState)
    }

    window.initMap = initMap

    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (p) => {
            userPos = { lat: p.coords.latitude, lng: p.coords.longitude }
            updateMapCenter()
          },
          () => { alert("Eroare GPS.") }
        )
      } else {
        alert("Fara suport GPS.")
      }
    }

    function updateMapCenter() {
      if (!map || !circle) return
      map.setCenter(userPos)
      map.setZoom(15)
      circle.setCenter(userPos)
    }

    function updateRouteMode() {
      saveState()
      if (currentSelectedDest && currentSelectedMsgId) {
        calculateAndDisplayRoute(currentSelectedDest, currentSelectedMsgId)
      }
    }

    function nearbySearchAsync(req) {
      return new Promise((resolve) => {
        service.nearbySearch(req, (res, status) => {
          if (status === "OK" && res) resolve(res)
          else resolve([])
        })
      })
    }

    async function runScan() {
      const rad = byId("rad")
      const cat = byId("cat")
      const sort = byId("sort")
      const modeSel = byId("travelMode")
      const city = byId("city")

      const r = rad ? parseInt(rad.value, 10) : 1500
      const cRaw = cat ? cat.value : "convenience_store"
      const s = sort ? sort.value : "dist"
      const mode = modeSel ? modeSel.value : "TRANSIT"
      const cityText = city ? (city.value || "") : ""

      saveState()

      if (circle) circle.setRadius(r)
      if (directionsRenderer) directionsRenderer.setDirections({ routes: [] })
      const svPanel = byId("sv-panel")
      if (svPanel) svPanel.style.display = "none"
      currentSelectedDest = null
      currentSelectedMsgId = null

      const center = circle ? circle.getCenter() : new google.maps.LatLng(userPos.lat, userPos.lng)
      const cats = getCategoryKeywords(cRaw)
      const list = byId("results")
      if (list) list.innerHTML = '<div style="padding:10px; color:#777">Caut...</div>'

      const all = new Map()
      for (const kw of cats) {
        const req = { location: center, radius: r, keyword: kw }
        const res = await nearbySearchAsync(req)
        res.forEach(p => { if (p.place_id && !all.has(p.place_id)) all.set(p.place_id, p) })
      }

      const res = Array.from(all.values())

      if (list) list.innerHTML = ""
      markers.forEach(m => m.setMap(null))
      markers = []

      const histEntry = {
        city: cityText,
        cat: cRaw,
        catLabel: labelForCategoryValue(cRaw),
        rad: r,
        sort: s,
        sortLabel: labelForSort(s),
        mode: mode,
        modeLabel: labelForMode(mode),
        ts: Date.now()
      }
      addHistoryEntry(histEntry)

      const countEl = byId("count")

      if (res.length) {
        res.forEach(p => p.realDist = google.maps.geometry.spherical.computeDistanceBetween(center, p.geometry.location))
        const filtered = res.filter(p => p.realDist <= r)
        if (countEl) countEl.innerText = String(filtered.length)

        if (s === "dist") filtered.sort((a, b) => a.realDist - b.realDist)
        else if (s === "rate") filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0))
        else filtered.sort((a, b) => ((b.rating || 0) * 1000 - a.realDist) - ((a.rating || 0) * 1000 - b.realDist))

        filtered.forEach((p, idx) => {
          markers.push(new google.maps.Marker({ map: map, position: p.geometry.location, title: p.name }))

          const badge = idx === 0 ? '<div class="best-badge">BEST</div>' : ""
          const thumbUrl = (p.photos && p.photos.length) ? p.photos[0].getUrl({ maxWidth: 100 }) : "https://via.placeholder.com/60?text=NoImg"
          const favSymbol = (p.place_id && isFav(p.place_id)) ? "‚òÖ" : "‚òÜ"
          const safePlaceId = (p.place_id || "").replace(/'/g, "")

          const card = document.createElement("div")
          card.className = "card"
          card.onclick = () => selectLocation(p.geometry.location.lat(), p.geometry.location.lng(), `route-msg-${idx}`, p)

          card.innerHTML = `
            <img src="${thumbUrl}" class="place-img">
            <div class="place-info">
              ${badge}
              <b>${p.name}</b><br>
              <span style="color:#f1c40f">${p.rating || "-"} ‚òÖ</span> |
              <span style="color:#aaa; font-size:11px">${Math.round(p.realDist)}m</span>
              <div id="route-msg-${idx}" class="route-info">...</div>
              <div id="steps-${idx}" class="transit-steps"></div>
            </div>
            <div class="fav-btn" data-fav-id="${safePlaceId}">${favSymbol}</div>
          `

          const favBtn = card.querySelector(".fav-btn")
          favBtn.onclick = (ev) => {
            ev.stopPropagation()
            toggleFav(p)
          }

          if (list) list.appendChild(card)
        })
      } else {
        if (list) list.innerHTML = '<div style="padding:10px; color:#777">Niciun rezultat.</div>'
        if (countEl) countEl.innerText = "0"
      }
    }

    function selectLocation(lat, lng, msgId, placeObj) {
      const dest = { lat: lat, lng: lng }
      currentSelectedDest = dest
      currentSelectedMsgId = msgId

      const panel = byId("sv-panel")
      if (panel) panel.style.display = "block"
      if (miniStreetView) miniStreetView.setPosition(dest)

      const svService = new google.maps.StreetViewService()
      svService.getPanorama({ location: dest, radius: 50 }, (data, status) => {
        if (status !== "OK" && panel) panel.style.display = "none"
      })

      calculateAndDisplayRoute(dest, msgId)
    }

    function iconForMode(mode) {
      if (mode === "TRANSIT") return "üöå"
      if (mode === "WALKING") return "üö∂"
      if (mode === "BICYCLING") return "üö¥"
      return "üöó"
    }

    function directionsRequest(origin, dest, mode) {
      return {
        origin: origin,
        destination: dest,
        travelMode: google.maps.TravelMode[mode],
        provideRouteAlternatives: true
      }
    }

    function calculateAndDisplayRoute(dest, msgId) {
      const modeSel = byId("travelMode")
      const mode = modeSel ? modeSel.value : "TRANSIT"

      document.querySelectorAll(".route-info").forEach(e => e.style.display = "none")
      document.querySelectorAll(".transit-steps").forEach(e => e.innerHTML = "")

      const div = byId(msgId)
      const stepsDiv = byId(msgId.replace("route-msg-", "steps-"))
      if (!div) return
      div.style.display = "block"
      div.innerText = "Calculare..."

      const attempt = (tryMode, fallbackMode, note) => {
        directionsService.route(directionsRequest(userPos, dest, tryMode), (res, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(res)
            const leg = res.routes[0].legs[0]
            const icon = iconForMode(tryMode)

            div.innerHTML = `${icon} ${leg.duration.text} (${leg.distance.text})`

            if (tryMode === "TRANSIT" && stepsDiv) {
              let stepSummary = ""
              leg.steps.forEach(step => {
                if (step.travel_mode === "TRANSIT" && step.transit) {
                  const line = step.transit.line.short_name || step.transit.line.name
                  const vehicle = (step.transit.line.vehicle && step.transit.line.vehicle.name) ? step.transit.line.vehicle.name : "Transit"
                  stepSummary += `<span class="step-badge" style="background:#2980b9">${vehicle} ${line}</span> `
                } else if (step.travel_mode === "WALKING") {
                  stepSummary += `<span class="step-badge">üö∂ ${step.duration.text}</span> `
                }
              })
              stepsDiv.innerHTML = stepSummary ? ("Traseu: " + stepSummary) : "Doar mers pe jos (prea aproape)."
            } else if (stepsDiv) {
              stepsDiv.innerHTML = note ? `<span class="mini-muted">${note}</span>` : ""
            }
          } else {
            if (fallbackMode) {
              attempt(fallbackMode, null, note)
              return
            }
            div.innerText = "Nu exista ruta."
          }
        })
      }

      if (mode === "BICYCLING") {
        attempt("BICYCLING", "WALKING", "BicicletƒÉ nu are rutƒÉ disponibilƒÉ aici. Am afi»ôat mers pe jos.")
        return
      }

      attempt(mode, null, "")
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvbL5aBjXtO-_61bYgMKj2G9o3sEtztGY&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html>
