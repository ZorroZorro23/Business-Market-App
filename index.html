<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AtlasGo Market Scanner</title>
  <style>
    /* Dark Mode Professional Theme */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; display: flex; height: 100vh; overflow: hidden; }
    
    #sidebar { width: 350px; background: #222; border-right: 1px solid #444; padding: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10; box-shadow: 2px 0 10px #000; }
    h2 { color: #3b82f6; margin: 0 0 10px 0; font-size: 22px; }
    label { font-size: 11px; color: #aaa; font-weight: bold; display: block; margin-bottom: 3px; }
    
    input, select, button { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
    button { font-weight: bold; cursor: pointer; text-transform: uppercase; border: none; transition: 0.2s; }
    
    .btn-scan { background: #3b82f6; margin-top: 5px; } 
    .btn-scan:hover { background: #2563eb; }
    .btn-geo { background: transparent; border: 1px solid #27ae60; color: #27ae60; margin-bottom: 15px; }
    .btn-geo:hover { background: rgba(39, 174, 96, 0.1); }
    .btn-csv { background: #444; } 
    .btn-csv:hover { background: #555; }
    
    #results { flex: 1; overflow-y: auto; border-top: 1px solid #444; padding-top: 10px; }
    
    /* Carduri Rezultate */
    .card { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; position: relative; transition: 0.2s; display: flex; gap: 10px; }
    .card:hover { background: #2a2a2a; border-left: 3px solid #3b82f6; }
    .place-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #444; }
    .place-info { flex: 1; }
    
    .route-info { font-size: 11px; color: #27ae60; margin-top: 5px; font-weight: bold; display: none; }
    .transit-steps { 
      font-size: 10px; color: #ddd; margin-top: 4px; 
      background: rgba(255,255,255,0.1); padding: 4px; border-radius: 4px;
    }
    .step-badge {
      display: inline-block; background: #333; border: 1px solid #555; 
      padding: 1px 4px; border-radius: 3px; margin-right: 3px; margin-bottom: 2px;
    }

    .best-badge { position: absolute; top: 8px; right: 8px; background: #27ae60; font-size: 9px; padding: 2px 5px; border-radius: 3px; }

    /* Fereastra Street View */
    #sv-panel {
      position: absolute; bottom: 30px; right: 20px;
      width: 350px; height: 250px;
      background: #000; border: 3px solid #fff; border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.7);
      display: none; z-index: 99; overflow: hidden;
    }
    #sv-container { width: 100%; height: 100%; }
    #sv-close { 
      position: absolute; top: 5px; right: 5px; 
      background: #e74c3c; color: white; border: none; 
      width: 25px; height: 25px; border-radius: 50%; 
      font-weight: bold; cursor: pointer; z-index: 100;
    }
    #sv-label {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(0,0,0,0.6); color: white;
      font-size: 10px; padding: 5px; text-align: center; pointer-events: none; z-index: 99;
    }

    #map { flex: 1; height: 100%; }
  </style>
</head>
<body>

  <div id="sidebar">
    <h2>AtlasGo <span style="font-size:12px; color:#888">v4.0 Student</span></h2>
    
    <button class="btn-geo" onclick="locateUser()">üìç LocalizeazƒÉ-mƒÉ (GPS)</button>

    <label>CAUTA ORAS</label>
    <input id="city" type="text" placeholder="Ex: Voluntari...">

    <label>CATEGORIE</label>
    <select id="cat">
      <option value="convenience_store">Magazine / Minimarket</option>
      <option value="gas_station">Benzinarii</option>
      <option value="restaurant|cafe">Restaurante</option>
      <option value="tourist_attraction">Turism</option>
      <option value="spa|park">Relaxare</option>
      <option value="pharmacy">Farmacii</option>
      <option value="gym">Sala Fitness</option>
    </select>

    <div style="display:flex; gap:10px;">
      <div style="flex:1">
        <label>MOD TRANSPORT</label>
        <select id="travelMode" onchange="updateRouteMode()">
          <option value="DRIVING">üöó Ma»ôinƒÉ</option>
          <option value="TRANSIT" selected>üöå Autobuz/Metrou</option>
          <option value="WALKING">üö∂ Jos</option>
          <option value="BICYCLING">üö¥ BicicletƒÉ</option>
        </select>
      </div>
      <div style="flex:1">
        <label>RAZA: <span id="rVal">1500</span>m</label>
        <input id="rad" type="range" min="500" max="10000" value="1500" step="100" oninput="document.getElementById('rVal').innerText=this.value">
      </div>
    </div>

    <label>SORTARE</label>
    <select id="sort">
      <option value="dist">Distanta (Cel mai aproape)</option>
      <option value="rate">Rating (Cel mai bun)</option>
      <option value="best">Balansat (Best Match)</option>
    </select>

    <button class="btn-scan" onclick="runScan()">Scaneaza Zona</button>
    <button class="btn-csv" onclick="getCSV()">Exporta CSV</button>
    
    <div style="font-size:11px; color:#666; margin-top:5px">
        Rezultate: <span id="count">0</span>
        <span style="float:right"><a href="./admin.html" style="color:#3b82f6; text-decoration:none">Admin</a></span>
    </div>
    <div id="results"></div>
  </div>

  <div style="position:relative; flex:1">
    <div id="map"></div>
    <div id="sv-panel">
      <button id="sv-close" onclick="document.getElementById('sv-panel').style.display='none'">X</button>
      <div id="sv-container"></div>
      <div id="sv-label">Street View Interactiv</div>
    </div>
  </div>

  <script type="module">
    // AICI ESTE CONFIGURATIA TA REALA (Din poza trimisa)
    const firebaseConfig = {
      apiKey: "AIzaSyC7a_97XoJn58dXB2c2wdez_MkBy9X50f8",
      authDomain: "atlas-e5b69.firebaseapp.com",
      projectId: "atlas-e5b69",
      storageBucket: "atlas-e5b69.firebasestorage.app",
      messagingSenderId: "880434544456",
      appId: "1:880434544456:web:caa2718bb344a1bb3a3d7d",
      measurementId: "G-NQJTWMJCZJ"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Session ID
    function getSessionId() {
      const k = "atlasgo_session_id";
      let sid = localStorage.getItem(k);
      if (!sid) {
        sid = crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random().toString(16).slice(2));
        localStorage.setItem(k, sid);
      }
      return sid;
    }

    // Functie de tracking
    async function trackEvent(type, payload = {}) {
      try {
        await addDoc(collection(db, "events"), {
          type,
          payload,
          sessionId: getSessionId(),
          ts: serverTimestamp(),
          ua: navigator.userAgent || "",
          lang: navigator.language || "",
        });
      } catch (e) {
        console.warn("Analytics error (check Firestore rules):", e);
      }
    }

    window.__trackEvent = trackEvent;
    trackEvent("page_view", { page: "index" });
  </script>

  <script>
    let map, circle, service, directionsService, directionsRenderer;
    let miniStreetView; 
    let markers = [];
    let exportData = [];
    let userPos = { lat: 44.4268, lng: 26.1025 }; 
    
    let currentSelectedDest = null; 
    let currentSelectedMsgId = null;

    function getCategoryKeywords(raw) {
      return raw.split("|").map(s => s.trim()).filter(Boolean);
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: userPos, zoom: 13, 
        disableDefaultUI: false, streetViewControl: true, mapTypeControl: false
      });

      new google.maps.TransitLayer().setMap(map);

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map, suppressMarkers: true,
        polylineOptions: { strokeColor: "#3b82f6", strokeWeight: 6, strokeOpacity: 0.7 }
      });

      miniStreetView = new google.maps.StreetViewPanorama(
        document.getElementById("sv-container"), {
          position: userPos, pov: { heading: 34, pitch: 10 },
          visible: true, disableDefaultUI: false, zoomControl: true, panControl: true
        }
      );

      circle = new google.maps.Circle({
        map, center: userPos, radius: 1500,
        fillColor: '#3b82f6', fillOpacity: 0.1, strokeColor: '#3b82f6', strokeWeight: 2,
        editable: true, draggable: true
      });
      circle.addListener('center_changed', () => { userPos = circle.getCenter(); });

      service = new google.maps.places.PlacesService(map);
      
      const ac = new google.maps.places.Autocomplete(document.getElementById('city'));
      ac.bindTo('bounds', map);
      ac.addListener('place_changed', () => {
        const p = ac.getPlace();
        if(p.geometry) { 
            userPos = p.geometry.location; 
            updateMapCenter(); 
            if(window.__trackEvent) window.__trackEvent("city_change", {hasGeometry:true});
        }
      });

      if(window.__trackEvent) window.__trackEvent("map_ready", {});
    }

    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (p) => { 
            userPos = { lat: p.coords.latitude, lng: p.coords.longitude }; 
            updateMapCenter(); 
            if(window.__trackEvent) window.__trackEvent("gps_success", {});
          },
          () => { 
            alert("Eroare GPS."); 
            if(window.__trackEvent) window.__trackEvent("gps_error", {});
          }
        );
      } else { alert("Fara suport GPS."); }
    }

    function updateMapCenter() {
      map.setCenter(userPos); map.setZoom(15); circle.setCenter(userPos);
    }

    function updateRouteMode() {
      if(currentSelectedDest && currentSelectedMsgId) {
        calculateAndDisplayRoute(currentSelectedDest, currentSelectedMsgId);
        if(window.__trackEvent) window.__trackEvent("travel_mode_change", {mode: document.getElementById('travelMode').value});
      }
    }

    function nearbySearchAsync(req) {
      return new Promise((resolve) => {
        service.nearbySearch(req, (res, status) => {
          if (status === 'OK' && res) resolve(res);
          else resolve([]);
        });
      });
    }

    async function runScan() {
      const r = parseInt(document.getElementById('rad').value, 10);
      const cRaw = document.getElementById('cat').value;
      const s = document.getElementById('sort').value;
      
      circle.setRadius(r);
      directionsRenderer.setDirections({routes: []});
      document.getElementById('sv-panel').style.display = 'none';
      currentSelectedDest = null; 

      const center = circle.getCenter();
      const cats = getCategoryKeywords(cRaw);
      const list = document.getElementById('results');
      list.innerHTML = '<div style="padding:10px; color:#777">Caut...</div>';

      if(window.__trackEvent) window.__trackEvent("scan", {radius:r, category:cRaw, sort:s});

      const all = new Map();
      for (const kw of cats) {
        const req = { location: center, radius: r, keyword: kw };
        const res = await nearbySearchAsync(req);
        res.forEach(p => { if (p.place_id && !all.has(p.place_id)) all.set(p.place_id, p); });
      }
      const res = Array.from(all.values());

      list.innerHTML = '';
      markers.forEach(m => m.setMap(null));
      markers = [];
      exportData = [];

      if(res.length) {
        res.forEach(p => p.realDist = google.maps.geometry.spherical.computeDistanceBetween(center, p.geometry.location));
        const filtered = res.filter(p => p.realDist <= r);
        document.getElementById('count').innerText = filtered.length;

        if(s === 'dist') filtered.sort((a,b) => a.realDist - b.realDist);
        else if (s === 'rate') filtered.sort((a,b) => (b.rating||0) - (a.rating||0));
        else filtered.sort((a,b) => ((b.rating||0)*1000 - b.realDist) - ((a.rating||0)*1000 - a.realDist));

        if(window.__trackEvent) window.__trackEvent("scan_results", { count: filtered.length });

        filtered.forEach((p, idx) => {
          exportData.push(p);
          markers.push(new google.maps.Marker({ map, position: p.geometry.location, title: p.name }));
          let badge = idx === 0 ? '<div class="best-badge">BEST</div>' : '';
          let thumbUrl = (p.photos && p.photos.length) ? p.photos[0].getUrl({maxWidth:100}) : "https://via.placeholder.com/60?text=NoImg";

          list.innerHTML += `
            <div class="card" onclick="selectLocation(${p.geometry.location.lat()}, ${p.geometry.location.lng()}, 'route-msg-${idx}', '${(p.place_id||'').replace(/'/g,"")}')">
              <img src="${thumbUrl}" class="place-img">
              <div class="place-info">
                ${badge}
                <b>${p.name}</b><br>
                <span style="color:#f1c40f">${p.rating||'-'} ‚òÖ</span> | 
                <span style="color:#aaa; font-size:11px">${Math.round(p.realDist)}m</span>
                <div id="route-msg-${idx}" class="route-info">...</div>
                <div id="steps-${idx}" class="transit-steps"></div>
              </div>
            </div>`;
        });
      } else {
        list.innerHTML = '<div style="padding:10px; color:#777">Niciun rezultat.</div>';
        document.getElementById('count').innerText = "0";
      }
    }

    function selectLocation(lat, lng, msgId, placeId) {
      const dest = { lat: lat, lng: lng };
      currentSelectedDest = dest;
      currentSelectedMsgId = msgId;

      if(window.__trackEvent) window.__trackEvent("select_place", { placeId: placeId, mode: document.getElementById('travelMode').value });

      const panel = document.getElementById('sv-panel');
      panel.style.display = 'block';
      miniStreetView.setPosition(dest); 
      
      const svService = new google.maps.StreetViewService();
      svService.getPanorama({ location: dest, radius: 50 }, (data, status) => {
        if (status !== 'OK') panel.style.display = 'none'; 
      });

      calculateAndDisplayRoute(dest, msgId);
    }

    function calculateAndDisplayRoute(dest, msgId) {
      const mode = document.getElementById('travelMode').value;
      const req = { origin: userPos, destination: dest, travelMode: google.maps.TravelMode[mode], provideRouteAlternatives: true };

      document.querySelectorAll('.route-info').forEach(e => e.style.display = 'none');
      document.querySelectorAll('.transit-steps').forEach(e => e.innerHTML = '');
      const div = document.getElementById(msgId);
      const stepsDiv = document.getElementById(msgId.replace('route-msg-', 'steps-'));
      
      div.style.display = 'block';
      div.innerText = "Calculare...";

      directionsService.route(req, (res, status) => {
        if (status == 'OK') {
          directionsRenderer.setDirections(res);
          const leg = res.routes[0].legs[0];
          
          let icon = "üöó";
          if(mode === "TRANSIT") icon = "üöå";
          if(mode === "WALKING") icon = "üö∂";
          if(mode === "BICYCLING") icon = "üö¥";

          let stepSummary = "";
          if (mode === "TRANSIT") {
             leg.steps.forEach(step => {
                if (step.travel_mode === "TRANSIT" && step.transit) {
                    let line = step.transit.line.short_name || step.transit.line.name;
                    let vehicle = (step.transit.line.vehicle && step.transit.line.vehicle.name) ? step.transit.line.vehicle.name : "Transit";
                    stepSummary += `<span class="step-badge" style="background:#2980b9">${vehicle} ${line}</span> `;
                } else if (step.travel_mode === "WALKING") {
                    stepSummary += `<span class="step-badge">üö∂ ${step.duration.text}</span> `;
                }
             });
          }
          
          div.innerHTML = `${icon} ${leg.duration.text} (${leg.distance.text})`;
          if (stepSummary) stepsDiv.innerHTML = "Traseu: " + stepSummary;
          else if (mode === "TRANSIT") stepsDiv.innerHTML = "Doar mers pe jos (prea aproape).";

          if(window.__trackEvent) window.__trackEvent("route_ok", {mode});
        } else {
          div.innerText = "Nu exista ruta.";
          if(window.__trackEvent) window.__trackEvent("route_fail", {mode, status});
        }
      });
    }

    function getCSV() {
      if(!exportData.length) return alert("Scaneaza intai o zona!");
      let csv = "Nume,Rating,Distanta(m),Adresa\n";
      exportData.forEach(p => {
        let n = (p.name||"").replace(/,/g, '');
        let a = (p.vicinity||'').replace(/,/g, '');
        csv += `${n},${p.rating||0},${Math.round(p.realDist||0)},${a}\n`;
      });
      if(window.__trackEvent) window.__trackEvent("export_csv", {rows: exportData.length});
      const b = new Blob([csv], {type:'text/csv'});
      const l = document.createElement('a');
      l.href = URL.createObjectURL(b); 
      l.download = 'analiza_piata.csv';
      l.click();
    }
  </script>
  
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvbL5aBjXtO-_61bYgMKj2G9o3sEtztGY&libraries=places,geometry&callback=initMap" async defer></script>
</body>
</html>
